## Implementation

Sourmash taxonomy conducts LCA-style taxonomic summarization of the genomic profiling results from sourmash gather.
It was introduced in sourmash v4.2.

### LCA-Style Lineage summarization

Sourmash gather uses a minimum set cover approach to identify the smallest set of reference genomes that contain all query information (k-mers) [@sourmash_gather].
These matches are non-overlapping; that is, the sum of the query fraction assigned to each genome will be at most 100% (entire query matched to reference genomes).

Sourmash taxonomy LCA approaches apply the taxonomic information from these reference genomes to their assigned query fraction and sum matches that correspond to the same taxonomic rank. For example, if the `sourmash gather` results for a metagenome include matches to 10 different strains of a given species, `sourmash tax` LCA can sum the fraction uniquely matched to each strain to obtain the total fraction uniquely matched to this species.

Because this approach relies upon non-overlapping reference assignments, separate `sourmash gather` results for the same query cannot be combined. However, `sourmash gather` can be run with any number of desired reference databases at once to produce a single set of non-overlapping assignments.

Two `sourmash tax` commands use this LCA-Style summarization: `metagenome` and `genome`.

<!--
tax commands rely upon the fact that gather provides both the total fraction of the query matched to each database matched, as well as a non-overlapping f_unique_to_query, which is the fraction of the query uniquely matched to each reference genome. The f_unique_to_query for any reference match will always be between (0% of query matched) and 1 (100% of query matched), and for a query matched to multiple references, the f_unique_to_query will sum to at most 1 (100% of query matched). We use this property to aggregate gather matches at the desired taxonomic rank. For example, if the gather results for a metagenome include results for 30 different strains of a given species, we can sum the fraction uniquely matched to each strain to obtain the fraction uniquely matched to this species. Alternatively, taxonomic summarization can take into account abundance weighting; see classifying signatures for more information.

-->

#### sourmash tax metagenome

“sourmash tax metagenome” is designed to conduct LCA aggregation for metagenomes to build a taxonomic profile.
`tax metagenome` ingests sourmash gather results from one or more metagenome queries and summarize the results for each metagenome at each taxonomic rank.
`tax metagenome` provides several output formats, including some that are designed to facilitate input into downstream analysis tools.

**krona**

**lineage_summary**

**kreport**

**csv_summary**

#### sourmash tax genome

`sourmash tax genome` is designed to aggregate sourmash gather results run on genome assemblies.
Rather than summarizing at each taxonomic rank, sourmash `tax genome` summarizes gather results starting from the lowest rank (species) and will classify the genome as soon as a user-modifiable criterion is reached. There are two classification strategies: classify the query once a match threshold is reached (e.g. 10% containment or 95% cANI), or classify the query once a rank is reached, regardless of percent match. The first strategy is recommended for more robust classification; the second strategy is required for downstream tools requiring all inputs at the same rank.

#### Outputs for downstream visualization

Note we also offer krona output from metagenome or rank-classified genome results, as well as a lineage_summary output for tax metagenome that may be useful for external multi-sample visualization tools.


### Utility commands

#### sourmash tax annotate

tax annotate annotates gather results with taxonomic information, without doing any LCA summarization.

#### sourmash tax prepare
tax prepare is a method for converting a csv of taxonomic lineage information into an sqlite database to enable faster loading and lineage assignment. It can also be used to combine lineage information for more that one database (e.g. GTDB, NCBI).

#### sourmash tax summarize

Summarize the lineage information in a human-reaedable summary

#### sourmash tax grep

select genomes entries by lineage; most useful for selecting subsets of results or reference genomes for sourmash analyses.